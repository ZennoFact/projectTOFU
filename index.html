<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>TOHU!</title>
    <link rel="stylesheet" href="./css/style.css">
  </head>
  <body>
    <!-- <canvas id="canvas"></canvas> -->
    <script src="./lib/Three.js"></script>
    <script src="./lib/physi.js"></script>
    <script src="./lib/OrbitControls.js"></script>
    <script src="./fontdata.js"></script>
    <script src="./tofufont.js"></script>
    <script>
    var scene;
    var renderer;
    var camera, directionalLight, ambientLight;
    var controls;

    init();
    render();

    // 環境の初期化
    function init() {
      renderer = new THREE.WebGLRenderer({antialias: true});
      renderer.setSize( window.innerWidth, window.innerHeight );
      renderer.setClearColor(0x082e80, 1);
      document.body.appendChild( renderer.domElement );
      renderer.shadowMap.enabled = true;

      // scene = new THREE.Scene();
      scene = new Physijs.Scene();
      scene.setGravity(new THREE.Vector3(0, -100, 0));

      camera = new THREE.PerspectiveCamera( 75, window.innerWidth/window.innerHeight, 1, 10000 );
      camera.position.set(0, 0, 300);

      ambientLight = new THREE.AmbientLight(0xeeeeee, 0.5);
      scene.add( ambientLight );

      directionalLight = new THREE.DirectionalLight( 0xffffff, 1.0 );
      directionalLight.position.set( 0, 7, 10 );
      scene.add( directionalLight );

      // マウスでの操作を可能にする
      controls = new THREE.OrbitControls(camera);
      // controls.enableDamping = true;
      controls.dampingFactor = 0.25;
      controls.userRotateSpeed = 0.8;
      // controls.autoRotate = true;
      // controls.autoRotateSpeed = 0.1;

      // 地面を作ってみる
      // Ground
  		ground_material = Physijs.createMaterial(
  			new THREE.MeshLambertMaterial({ color: 0x777777 }),
  			.8, // high friction
  			.3 // low restitution
  		);
      ground = new Physijs.BoxMesh(
  			new THREE.BoxGeometry(200, 1, 100),
  			ground_material,
  			0 // mass
  		);
      ground.position.set(0, -100, 0);
  		ground.receiveShadow = true;
  		scene.add( ground );

      window.addEventListener( 'resize', onWindowResize, false );
      window.addEventListener( 'keydown', function(e) {
        // console.log(e.keyCode);
        if (e.keyCode === 8) {
        window.event.returnValue = false;
          tofu.deleteChar();
        } else {
          tofu.createChar(fontData.get(e.keyCode));
        }
      } );
    }

    // 描画の更新用処理
    function render() {
      scene.simulate();

      tofu.animation();

    	controls.update();
    	renderer.render(scene, camera);

      requestAnimationFrame( render );
    }

    // 画面のリサイズに対応
    function onWindowResize() {
    	camera.aspect = window.innerWidth / window.innerHeight;
    	camera.updateProjectionMatrix();

    	renderer.setSize( window.innerWidth, window.innerHeight );
    }
    </script>
  </body>
</html>
